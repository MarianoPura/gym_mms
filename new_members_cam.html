<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Camera</title>
  <style>
    html,body { margin:0; padding:0; height:100%; background:#000; color:#fff; }
    .topbar { position:fixed; top:0; left:0; right:0; padding:12px 16px; background:rgba(0,0,0,.35); font:500 16px system-ui; backdrop-filter: blur(6px); }
    .wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    video, canvas, img { width:100vw; height:100vh; object-fit:cover; display:block; }
    .hint { position:fixed; bottom:20px; left:0; right:0; text-align:center; opacity:.8; font:400 14px system-ui; }
  </style>
</head>
<body>
  <div class="topbar">Tap anywhere to capture</div>
  <div class="wrap"><video id="cam" autoplay playsinline></video></div>
  <div class="hint">Uploading photoâ€¦</div>
  <script>
    const qs = new URLSearchParams(location.search);
    const token = qs.get('token');
    const v = document.getElementById('cam');
    const hint = document.querySelector('.hint');
    hint.style.display = 'none';

    async function start() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        v.srcObject = stream;
      } catch (e) { alert('Camera permission required'); }
    }

    function captureAndUpload() {
      if (!token) return;
      const c = document.createElement('canvas');
      c.width = v.videoWidth; c.height = v.videoHeight;
      c.getContext('2d').drawImage(v, 0, 0, c.width, c.height);
      const dataUrl = c.toDataURL('image/png');
      hint.style.display = 'block';

      const fd = new FormData();
      fd.append('token', token);
      fd.append('photo', dataUrl);
      fetch('scripts/upload_mobile_photo.php', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(j => {
          if (j.success) { hint.textContent = 'Uploaded. You may close this tab.'; }
          else { hint.textContent = 'Upload failed'; }
        })
        .catch(() => { hint.textContent = 'Upload error'; });
    }

    document.addEventListener('click', captureAndUpload, { once: true });
    start();
  </script>
</body>
</html>